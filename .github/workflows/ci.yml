name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-validate:
    name: Lint and Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm install -g htmlhint stylelint stylelint-config-standard eslint
        
    - name: Lint HTML
      run: |
        htmlhint index.html dashboard.html || echo "HTML linting completed with warnings"
        
    - name: Lint CSS
      run: |
        npx stylelint "*.css" --config-basedir . || echo "CSS linting completed with warnings"
      continue-on-error: true
        
    - name: Lint JavaScript
      run: |
        npx eslint "*.js" --no-eslintrc --env browser,es6 --parser-options ecmaVersion:2020 || echo "JS linting completed with warnings"
      continue-on-error: true

  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check required files
      run: |
        files=("index.html" "dashboard.html" "auth.js" "dashboard.js" "styles.css" "README.md" "ARCHITECTURE.md" "SECURITY.md" "CONTRIBUTING.md" "ROADMAP.md")
        for file in "${files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "Error: Required file $file is missing"
            exit 1
          else
            echo "✓ Found $file"
          fi
        done
        
    - name: Validate JSON syntax in JS files
      run: |
        echo "Checking for common JavaScript errors..."
        if grep -r "console.log" *.js; then
          echo "Warning: Found console.log statements"
        fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for secrets
      run: |
        echo "Scanning for potential secrets..."
        if grep -r -i "api[_-]key.*=.*['\"][a-zA-Z0-9]\{20,\}" . --exclude-dir=.git --exclude-dir=node_modules; then
          echo "Warning: Potential API key found in code"
          exit 1
        fi
        if grep -r -i "password.*=.*['\"][^'\"]\+" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md"; then
          echo "Warning: Potential hardcoded password found"
        fi
        
    - name: Check for security issues
      run: |
        echo "Checking for common security issues..."
        if grep -r "eval(" *.js; then
          echo "Warning: eval() usage found - potential security risk"
        fi
        if grep -r "innerHTML" *.js; then
          echo "Warning: innerHTML usage found - ensure content is sanitized"
        fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Basic functionality tests
      run: |
        echo "Running basic validation tests..."
        
        # Check if HTML files are valid
        if ! grep -q "<!DOCTYPE html>" index.html; then
          echo "Error: index.html missing DOCTYPE"
          exit 1
        fi
        
        if ! grep -q "<!DOCTYPE html>" dashboard.html; then
          echo "Error: dashboard.html missing DOCTYPE"
          exit 1
        fi
        
        # Check if CSS has basic structure
        if ! grep -q ":root" styles.css; then
          echo "Warning: CSS missing root variables"
        fi
        
        # Check if JavaScript files have no syntax errors (basic check)
        node -c auth.js
        node -c dashboard.js
        
        echo "✓ Basic validation tests passed"

  documentation:
    name: Check Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate documentation
      run: |
        echo "Checking documentation completeness..."
        
        # Check README
        if ! grep -q "## Features" README.md; then
          echo "Warning: README missing Features section"
        fi
        
        # Check ARCHITECTURE exists and has content
        if [ -f "ARCHITECTURE.md" ]; then
          if [ $(wc -l < ARCHITECTURE.md) -lt 50 ]; then
            echo "Warning: ARCHITECTURE.md seems incomplete"
          else
            echo "✓ ARCHITECTURE.md looks good"
          fi
        fi
        
        # Check SECURITY exists
        if [ -f "SECURITY.md" ]; then
          echo "✓ SECURITY.md exists"
        fi
        
        # Check CONTRIBUTING exists
        if [ -f "CONTRIBUTING.md" ]; then
          echo "✓ CONTRIBUTING.md exists"
        fi
        
        echo "Documentation check completed"

  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: Test with local server
      run: |
        echo "Starting local server..."
        python -m http.server 8000 &
        SERVER_PID=$!
        
        sleep 3
        
        # Test if server is running
        if curl -f http://localhost:8000/index.html > /dev/null 2>&1; then
          echo "✓ Server started successfully and index.html accessible"
        else
          echo "Error: Could not access application"
          kill $SERVER_PID
          exit 1
        fi
        
        # Test dashboard
        if curl -f http://localhost:8000/dashboard.html > /dev/null 2>&1; then
          echo "✓ dashboard.html accessible"
        else
          echo "Error: Could not access dashboard"
          kill $SERVER_PID
          exit 1
        fi
        
        kill $SERVER_PID
        echo "Build test completed successfully"

  accessibility:
    name: Accessibility Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for accessibility attributes
      run: |
        echo "Checking for basic accessibility features..."
        
        # Check for alt attributes on images (if any)
        if grep -q "<img" *.html; then
          echo "Images found - ensure they have alt attributes"
        fi
        
        # Check for ARIA labels
        if grep -q "aria-label" *.html; then
          echo "✓ Found ARIA labels"
        fi
        
        # Check for semantic HTML
        if grep -q "<nav>" *.html; then
          echo "✓ Using semantic nav element"
        fi
        
        if grep -q "<main>" *.html; then
          echo "✓ Using semantic main element"
        fi
        
        echo "Accessibility check completed"

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [lint-and-validate, validate-structure, security-scan, test, documentation, build-test, accessibility]
    if: always()
    
    steps:
    - name: Check job status
      run: |
        echo "Pipeline Status Summary:"
        echo "========================"
        echo "Lint and Validate: ${{ needs.lint-and-validate.result }}"
        echo "Validate Structure: ${{ needs.validate-structure.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "Tests: ${{ needs.test.result }}"
        echo "Documentation: ${{ needs.documentation.result }}"
        echo "Build Test: ${{ needs.build-test.result }}"
        echo "Accessibility: ${{ needs.accessibility.result }}"
        echo "========================"
        
        if [ "${{ needs.lint-and-validate.result }}" == "failure" ] || \
           [ "${{ needs.validate-structure.result }}" == "failure" ] || \
           [ "${{ needs.security-scan.result }}" == "failure" ] || \
           [ "${{ needs.test.result }}" == "failure" ] || \
           [ "${{ needs.build-test.result }}" == "failure" ]; then
          echo "❌ Pipeline failed"
          exit 1
        else
          echo "✅ Pipeline passed"
        fi
